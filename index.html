<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2C5F5D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kolyaè‡ªç”±å€’æ•¸">
    <link rel="apple-touch-icon" href="app-icon.png">
    <link rel="icon" type="image/png" href="app-icon.png">
    <title>Kolyaè‡ªç”±å€’æ•¸</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;600;700&family=LXGW+WenKai+TC:wght@300;400;700&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --sand-light: #F5F1EB;
            --sand-warm: #E8E0D5;
            --ocean-deep: #2C5F5D;
            --ocean-mid: #4A8B8B;
            --ocean-light: #7FB3B3;
            --earth-brown: #8B7355;
            --earth-dark: #5D4E3A;
            --driftwood: #A69580;
            --sunset-gold: #C9A962;
            --soft-shadow: rgba(93, 78, 58, 0.12);
            --text-primary: #3D3D3D;
            --text-secondary: #6B6B6B;
            --card-bg: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] {
            --sand-light: #1a1a2e;
            --sand-warm: #16213e;
            --ocean-deep: #4A8B8B;
            --ocean-mid: #7FB3B3;
            --ocean-light: #a8d5d5;
            --earth-brown: #c9a962;
            --earth-dark: #e8e0d5;
            --driftwood: #8B7355;
            --sunset-gold: #f0d78c;
            --soft-shadow: rgba(0, 0, 0, 0.3);
            --text-primary: #e8e0d5;
            --text-secondary: #a69580;
            --card-bg: rgba(22, 33, 62, 0.95);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--sand-light);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .background-layer {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 0;
        }

        .background-layer.no-bg {
            background-image: none !important;
            background: var(--sand-light);
        }

        .main-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 60px;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            overflow: hidden;
        }

        .title {
            font-family: 'LXGW WenKai TC', 'Noto Serif TC', serif;
            font-size: 1.4rem;
            font-weight: 400;
            color: var(--ocean-deep);
            margin-bottom: 12px;
            letter-spacing: 4px;
            background: rgba(255, 255, 255, 0.75);
            padding: 10px 22px;
            border-radius: 30px;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] .title {
            background: rgba(22, 33, 62, 0.8);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .title-icon { margin: 0 6px; }

        .unified-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px 30px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            text-align: center;
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .target-date {
            font-family: 'LXGW WenKai TC', serif;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .days-row {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .days-remaining {
            font-family: 'Noto Serif TC', serif;
            font-size: 4.5rem;
            font-weight: 700;
            color: var(--ocean-deep);
            line-height: 1;
        }

        .days-label {
            font-family: 'LXGW WenKai TC', serif;
            font-size: 1.3rem;
            color: var(--text-secondary);
        }

        .time-details {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 15px 0;
        }

        .time-item {
            text-align: center;
            padding: 8px 14px;
            background: var(--sand-warm);
            border-radius: 10px;
        }

        .time-value {
            font-family: 'Noto Serif TC', serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--earth-dark);
        }

        .time-unit { font-size: 0.75rem; color: var(--text-secondary); }

        .workdays {
            background: linear-gradient(135deg, var(--ocean-deep), var(--ocean-mid));
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .workdays-number {
            font-family: 'Noto Serif TC', serif;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .progress-section { margin-bottom: 18px; }

        .progress-bar {
            height: 6px;
            background: var(--sand-warm);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--ocean-mid), var(--sunset-gold));
            border-radius: 3px;
            transition: width 1s ease;
        }

        .progress-percent {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .quote-section {
            border-top: 1px solid var(--sand-warm);
            padding-top: 15px;
            margin-top: 5px;
        }

        .quote-text {
            font-family: 'LXGW WenKai TC', serif;
            font-size: 0.88rem;
            line-height: 1.7;
            color: var(--text-primary);
            margin-bottom: 6px;
            font-weight: 400;
        }

        .quote-text .quote-translation {
            display: block;
            margin-top: 4px;
            color: var(--text-secondary);
            font-size: 0.82rem;
        }

        .quote-author {
            font-family: 'LXGW WenKai TC', serif;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .milestone {
            background: linear-gradient(135deg, var(--sunset-gold), var(--earth-brown));
            color: white;
            padding: 10px 18px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 20px var(--soft-shadow);
            z-index: 100;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .nav-btn span { font-size: 1.3rem; }
        .nav-btn:hover, .nav-btn.active { color: var(--ocean-deep); background: var(--sand-warm); }

        .panel {
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 420px;
            height: 100%;
            background: var(--sand-light);
            z-index: 200;
            transition: all 0.4s ease;
            overflow-y: auto;
        }

        .settings-panel { right: -100%; }
        .wishlist-panel { left: -100%; }
        .settings-panel.open { right: 0; }
        .wishlist-panel.open { left: 0; }

        .panel-header {
            background: linear-gradient(135deg, var(--ocean-deep), var(--ocean-mid));
            color: white;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .panel-title { font-family: 'LXGW WenKai TC', serif; font-size: 1.2rem; }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px; height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .panel-content { padding: 15px; }

        .settings-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .section-title {
            font-family: 'LXGW WenKai TC', serif;
            font-size: 1rem;
            color: var(--earth-dark);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-header .section-title { margin-bottom: 0; }

        label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px; }

        input[type="date"], input[type="text"], textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--sand-warm);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: 'Noto Sans TC', sans-serif;
            color: var(--text-primary);
            background: var(--sand-light);
        }

        input:focus, textarea:focus { outline: none; border-color: var(--ocean-mid); }
        textarea { resize: vertical; min-height: 70px; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: 'Noto Sans TC', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary { background: linear-gradient(135deg, var(--ocean-deep), var(--ocean-mid)); color: white; }
        .btn-secondary { background: var(--sand-warm); color: var(--earth-dark); }
        .btn-cancel { background: #ccc; color: #555; }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; }
        .btn-block { width: 100%; }

        .mode-options { display: flex; flex-direction: column; gap: 8px; }

        .mode-option {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: var(--sand-warm);
            border-radius: 8px;
            cursor: pointer;
        }

        .mode-option.active { background: var(--ocean-deep); color: white; }
        .mode-option input { display: none; }
        .mode-icon { font-size: 1.1rem; margin-right: 10px; }

        /* åœ–åº«æ¨£å¼ */
        .image-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
            min-height: 80px;
        }

        .image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            background: var(--sand-warm);
        }

        .image-item.selected { border-color: var(--ocean-mid); }
        .image-item img { width: 100%; height: 100%; object-fit: cover; }

        .image-item .img-error {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.65rem;
            text-align: center;
            padding: 5px;
            background: var(--sand-warm);
        }

        .image-item .img-error .error-icon { font-size: 1.2rem; margin-bottom: 3px; }

        .image-item .img-actions {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .image-item:hover .img-actions { display: flex; }
        .image-item.error-item .img-actions { display: flex; background: transparent; }

        .img-action-btn {
            width: 32px; height: 32px;
            border: none;
            border-radius: 50%;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .img-action-btn.select { background: var(--ocean-mid); color: white; }
        .img-action-btn.delete { background: rgba(192, 57, 43, 0.9); color: white; }

        /* ç„¡èƒŒæ™¯é¸é … */
        .no-bg-option {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--sand-light), var(--sand-warm));
            color: var(--text-secondary);
            font-size: 0.75rem;
            border: 2px dashed var(--driftwood);
        }

        .no-bg-option.selected { border-color: var(--ocean-mid); border-style: solid; }

        .tabs { display: flex; gap: 5px; margin-bottom: 12px; }

        .tab {
            flex: 1;
            padding: 8px;
            background: var(--sand-warm);
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-primary);
            cursor: pointer;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .tab.active { background: var(--ocean-deep); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .theme-toggle { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; }

        .toggle-switch {
            position: relative;
            width: 50px; height: 26px;
            background: var(--sand-warm);
            border-radius: 13px;
            cursor: pointer;
        }

        .toggle-switch.active { background: var(--ocean-deep); }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px; left: 3px;
            width: 20px; height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active::after { transform: translateX(24px); }

        /* ç·¨è¼¯æŒ‰éˆ•çµ„ */
        .edit-btn-group {
            display: flex;
            gap: 5px;
        }

        .edit-btn-group .btn {
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        /* é¡˜æœ›æ¸…å–® */
        .add-wish-form { display: flex; gap: 8px; margin-bottom: 15px; }
        .add-wish-form input { flex: 1; }

        .wish-list-wrapper {
            position: relative;
            height: calc(100vh - 280px);
            min-height: 200px;
        }

        .wish-list {
            height: 100%;
            overflow-y: auto;
            padding-right: 5px;
        }

        .scroll-zone {
            position: absolute;
            left: 0; right: 0;
            height: 60px;
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .scroll-zone.top { top: 0; background: linear-gradient(to bottom, rgba(74,139,139,0.3), transparent); }
        .scroll-zone.bottom { bottom: 0; background: linear-gradient(to top, rgba(74,139,139,0.3), transparent); }
        .scroll-zone.active { opacity: 1; }

        .wish-group {
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .wish-group.dragging { opacity: 0.5; }

        .wish-parent {
            display: flex;
            align-items: center;
            padding: 12px 15px;
        }

        .drag-handle {
            color: var(--driftwood);
            margin-right: 10px;
            font-size: 1.2rem;
            cursor: grab;
            touch-action: none;
            user-select: none;
        }

        .drag-handle:active { cursor: grabbing; }

        .wish-checkbox {
            width: 22px; height: 22px;
            border: 2px solid var(--ocean-mid);
            border-radius: 50%;
            margin-right: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.7rem;
        }

        .wish-checkbox.checked { background: var(--ocean-mid); color: white; }

        .wish-text {
            flex: 1;
            font-size: 0.95rem;
            color: var(--text-primary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .wish-text:hover { background: var(--sand-warm); }
        .wish-text.completed { text-decoration: line-through; color: var(--text-secondary); }

        .wish-text-input {
            flex: 1;
            padding: 6px 8px;
            border: 2px solid var(--ocean-mid);
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: 'Noto Sans TC', sans-serif;
            background: white;
        }

        .wish-actions { display: flex; gap: 5px; }

        .wish-action-btn {
            width: 28px; height: 28px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wish-action-btn:hover { background: var(--sand-warm); }
        .wish-action-btn.delete:hover { background: rgba(192, 57, 43, 0.1); color: #c0392b; }

        .expand-btn { transition: transform 0.3s ease; }
        .expand-btn.expanded { transform: rotate(180deg); }

        .sub-wishes { padding: 0 15px 10px 50px; display: none; }
        .sub-wishes.show { display: block; }

        .sub-wish-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--sand-warm);
        }

        .sub-wish-item:last-child { border-bottom: none; }
        .sub-wish-item .wish-checkbox { width: 18px; height: 18px; margin-right: 10px; }
        .sub-wish-item .wish-text { font-size: 0.9rem; }

        .sub-wish-item .drag-handle-sub {
            color: var(--driftwood);
            margin-right: 8px;
            font-size: 1rem;
            cursor: grab;
        }

        .sub-wish-item.dragging { opacity: 0.5; background: var(--sand-warm); border-radius: 6px; }

        .add-sub-wish {
            display: flex;
            align-items: center;
            padding: 8px 0;
            color: var(--ocean-mid);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .add-sub-wish:hover { color: var(--ocean-deep); }

        .drop-zone {
            height: 8px;
            margin: 2px 0;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .drop-zone.active {
            height: 40px;
            background: rgba(74, 139, 139, 0.15);
            border: 2px dashed var(--ocean-mid);
        }

        .sub-drop-zone {
            height: 4px;
            margin: 2px 0;
            transition: all 0.2s ease;
        }

        .sub-drop-zone.active {
            height: 30px;
            background: rgba(74, 139, 139, 0.15);
            border: 2px dashed var(--ocean-mid);
            border-radius: 4px;
        }

        /* åè¨€ç®¡ç† */
        .quote-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .quote-list-header input { flex: 1; }

        .quote-list { max-height: 280px; overflow-y: auto; margin-top: 8px; }

        .quote-item {
            background: var(--sand-warm);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            position: relative;
        }

        .quote-item.hidden-quote { opacity: 0.5; }

        .quote-item-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 4px;
            padding-right: 80px;
            line-height: 1.5;
        }

        .quote-item-author { font-size: 0.75rem; color: var(--text-secondary); }

        .quote-item-actions {
            position: absolute;
            top: 8px; right: 8px;
            display: none;
            gap: 4px;
        }

        .quote-item-actions.show { display: flex; }

        .quote-action-btn {
            width: 26px; height: 26px;
            border: none;
            border-radius: 50%;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quote-action-btn.edit { background: var(--ocean-mid); color: white; }
        .quote-action-btn.hide { background: var(--driftwood); color: white; }
        .quote-action-btn.delete { background: rgba(192, 57, 43, 0.8); color: white; }
        .quote-action-btn.restore { background: var(--sunset-gold); color: white; }

        .restore-all-btn {
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .edit-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 350;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .edit-modal.show { display: flex; }

        .edit-modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 350px;
        }

        .edit-modal-title {
            font-family: 'LXGW WenKai TC', serif;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--earth-dark);
        }

        .edit-modal textarea { min-height: 100px; margin-bottom: 10px; }
        .edit-modal input { margin-bottom: 15px; }

        .edit-modal-btns { display: flex; gap: 10px; }
        .edit-modal-btns .btn { flex: 1; }

        .storage-info {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 10px;
            padding: 8px;
            background: var(--sand-warm);
            border-radius: 6px;
        }

        .backup-info {
            background: var(--sand-warm);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .backup-info strong { color: var(--earth-dark); }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-state span { font-size: 2.5rem; display: block; margin-bottom: 10px; }

        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--earth-dark);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 400;
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.35);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }

        .overlay.show { opacity: 1; visibility: visible; }

        .hidden-input { display: none; }
        .input-hint { font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px; line-height: 1.4; }
        .btn-group { display: flex; gap: 8px; margin-top: 12px; }
        .btn-group .btn { flex: 1; }

        .celebration-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        .celebration-overlay.show { opacity: 1; visibility: visible; }

        .celebration-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 35px;
            text-align: center;
            max-width: 320px;
            transform: scale(0.8);
            transition: transform 0.5s ease;
        }

        .celebration-overlay.show .celebration-card { transform: scale(1); }
        .celebration-emoji { font-size: 3.5rem; margin-bottom: 15px; animation: bounce 1s infinite; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .celebration-title { font-family: 'LXGW WenKai TC', serif; font-size: 1.4rem; color: var(--ocean-deep); margin-bottom: 8px; }
        .celebration-message { font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 20px; }

        .confetti {
            position: fixed;
            width: 10px; height: 10px;
            z-index: 501;
            animation: fall 3s linear forwards;
        }

        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .bulk-import-area { min-height: 120px; font-family: monospace; font-size: 0.8rem; line-height: 1.5; }

        @media (max-height: 700px) {
            .main-container { padding: 10px; }
            .title { font-size: 1.2rem; margin-bottom: 8px; }
            .unified-card { padding: 20px 25px; }
            .days-remaining { font-size: 3.8rem; }
            .time-details { gap: 8px; margin: 10px 0; }
            .time-item { padding: 6px 10px; }
            .time-value { font-size: 1rem; }
            .workdays { padding: 8px 15px; font-size: 0.85rem; margin-bottom: 10px; }
            .quote-section { padding-top: 12px; }
            .quote-text { font-size: 0.82rem; }
        }

        @media (max-height: 600px) {
            .time-details { display: none; }
            .days-remaining { font-size: 3.2rem; }
        }

        @media (max-width: 380px) {
            .unified-card { padding: 18px 20px; }
            .days-remaining { font-size: 3.5rem; }
            .image-list { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="background-layer" id="bgLayer"></div>

    <div class="main-container">
        <h1 class="title" id="mainTitle">
            <span class="title-icon">ğŸŒŠ</span><span id="titleText">Kolyaè‡ªç”±å€’æ•¸</span><span class="title-icon">â›º</span>
        </h1>
        
        <div class="unified-card">
            <div class="target-date" id="targetDate">ç›®æ¨™æ—¥æœŸï¼š2028å¹´2æœˆ10æ—¥</div>
            <div class="milestone" id="milestone" style="display: none;"></div>
            
            <div class="days-row">
                <div class="days-remaining" id="daysRemaining">---</div>
                <div class="days-label">å¤©</div>
            </div>
            
            <div class="time-details">
                <div class="time-item">
                    <div class="time-value" id="yearsRemaining">-</div>
                    <div class="time-unit">å¹´</div>
                </div>
                <div class="time-item">
                    <div class="time-value" id="monthsRemaining">-</div>
                    <div class="time-unit">æœˆ</div>
                </div>
                <div class="time-item">
                    <div class="time-value" id="weeksRemaining">-</div>
                    <div class="time-unit">é€±</div>
                </div>
            </div>
            
            <div class="workdays">
                é‚„è¦ä¸Šç­ <span class="workdays-number" id="workdaysRemaining">---</span> å¤©
            </div>
            
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-percent" id="progressPercent">å·²å®Œæˆ 0%</div>
            </div>

            <div class="quote-section">
                <div class="quote-text" id="quoteText">ã€Œè¼‰å…¥ä¸­...ã€</div>
                <div class="quote-author" id="quoteAuthor"></div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn" id="wishlistBtn"><span>ğŸ“‹</span>é¡˜æœ›</button>
        <button class="nav-btn active" id="homeBtn"><span>ğŸ </span>é¦–é </button>
        <button class="nav-btn" id="settingsBtn"><span>âš™ï¸</span>è¨­å®š</button>
    </div>

    <div class="overlay" id="overlay"></div>

    <!-- é¡˜æœ›æ¸…å–®é¢æ¿ -->
    <div class="panel wishlist-panel" id="wishlistPanel">
        <div class="panel-header">
            <div class="panel-title">ğŸ“‹ é¡˜æœ›æ¸…å–®</div>
            <button class="close-btn" id="closeWishlistBtn">âœ•</button>
        </div>
        <div class="panel-content">
            <div class="add-wish-form">
                <input type="text" id="newWishInput" placeholder="æ–°å¢é¡˜æœ›...">
                <button class="btn btn-primary" id="addWishBtn">â•</button>
            </div>
            <p class="input-hint" style="margin-bottom:15px;">ğŸ’¡ é»æ–‡å­—å¯ç·¨è¼¯ï½œæ‹– â˜° èª¿é †åºï½œå­é …å¯æ‹–åˆ°å¤–é¢è®Šæ¯é …</p>
            <div class="wish-list-wrapper">
                <div class="scroll-zone top" id="scrollZoneTop"></div>
                <div class="wish-list" id="wishList"></div>
                <div class="scroll-zone bottom" id="scrollZoneBottom"></div>
            </div>
            <p class="input-hint" id="wishCount">å…± 0 å€‹é¡˜æœ›</p>
        </div>
    </div>

    <!-- è¨­å®šé¢æ¿ -->
    <div class="panel settings-panel" id="settingsPanel">
        <div class="panel-header">
            <div class="panel-title">âš™ï¸ è¨­å®š</div>
            <button class="close-btn" id="closeBtn">âœ•</button>
        </div>
        
        <div class="panel-content">
            <div class="settings-section">
                <div class="section-title"><span>ğŸŒ™</span> é¡¯ç¤ºæ¨¡å¼</div>
                <div class="theme-toggle">
                    <span>æ·±è‰²æ¨¡å¼</span>
                    <div class="toggle-switch" id="themeToggle"></div>
                </div>
            </div>

            <div class="settings-section">
                <div class="section-title"><span>âœï¸</span> é¦–é æ¨™é¡Œ</div>
                <input type="text" id="customTitle" placeholder="Kolyaè‡ªç”±å€’æ•¸">
                <button class="btn btn-primary btn-block" style="margin-top: 10px;" id="saveTitleBtn">ğŸ’¾ å„²å­˜æ¨™é¡Œ</button>
            </div>

            <div class="settings-section">
                <div class="section-title"><span>ğŸ“…</span> é€€ä¼‘æ—¥æœŸ</div>
                <input type="date" id="retirementDate" value="2028-02-10">
                <button class="btn btn-primary btn-block" style="margin-top: 10px;" id="saveDateBtn">ğŸ’¾ å„²å­˜æ—¥æœŸ</button>
            </div>

            <div class="settings-section">
                <div class="section-title"><span>ğŸ–¼ï¸</span> èƒŒæ™¯åœ–ç‰‡</div>
                
                <div class="mode-options">
                    <label class="mode-option" id="modeDaily">
                        <input type="radio" name="bgMode" value="daily">
                        <span class="mode-icon">ğŸ“†</span><span>æ¯æ—¥æ›</span>
                    </label>
                    <label class="mode-option" id="modeRandom">
                        <input type="radio" name="bgMode" value="random">
                        <span class="mode-icon">ğŸ²</span><span>éš¨æ©Ÿæ›</span>
                    </label>
                    <label class="mode-option" id="modeFixed">
                        <input type="radio" name="bgMode" value="fixed">
                        <span class="mode-icon">ğŸ“Œ</span><span>å›ºå®š</span>
                    </label>
                </div>
                
                <p class="input-hint" style="margin-top:10px;">æ»‘é¼ ç§»åˆ°åœ–ç‰‡ä¸Šå¯é¸æ“‡æˆ–åˆªé™¤</p>
                <div class="image-list" id="imageList"></div>
                
                <div style="margin-top: 15px;">
                    <div class="tabs">
                        <button class="tab active" data-tab="upload">ä¸Šå‚³</button>
                        <button class="tab" data-tab="url">ç¶²å€</button>
                    </div>
                    <div class="tab-content active" id="tabUpload">
                        <input type="file" accept="image/*" id="imageUpload" class="hidden-input">
                        <button class="btn btn-secondary btn-block" id="uploadBtn">ğŸ“· é¸æ“‡ç…§ç‰‡</button>
                        <p class="input-hint">å¾æ‰‹æ©Ÿæˆ–é›»è…¦é¸æ“‡åœ–ç‰‡ä¸Šå‚³ï¼ˆå»ºè­°å°æ–¼ 500KBï¼‰</p>
                    </div>
                    <div class="tab-content" id="tabUrl">
                        <input type="text" id="imageUrl" placeholder="è²¼ä¸Šåœ–ç‰‡ç¶²å€...">
                        <p class="input-hint">âš ï¸ è¨±å¤šç¶²ç«™æœƒé˜»æ“‹å¤–éƒ¨å¼•ç”¨ï¼Œå»ºè­°ç”¨ã€Œä¸Šå‚³ã€åŠŸèƒ½</p>
                        <button class="btn btn-secondary btn-block" style="margin-top: 8px;" id="addUrlBtn">â• æ–°å¢</button>
                    </div>
                </div>
                
                <div class="storage-info" id="storageInfo">å„²å­˜ç©ºé–“...</div>
            </div>

            <div class="settings-section">
                <div class="section-header">
                    <div class="section-title"><span>ğŸ’¬</span> åè¨€ä½³å¥</div>
                    <div class="edit-btn-group" id="quoteEditBtnGroup">
                        <button class="btn btn-secondary" id="quoteEditBtn">âœï¸ ç·¨è¼¯</button>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab active" data-tab="addQuote">æ–°å¢</button>
                    <button class="tab" data-tab="bulkImport">æ‰¹é‡</button>
                    <button class="tab" data-tab="manageQuotes">ç®¡ç†</button>
                </div>
                <div class="tab-content active" id="tabAddQuote">
                    <textarea id="newQuoteText" placeholder="åè¨€å…§å®¹...ï¼ˆè‹±æ–‡èˆ‡ä¸­æ–‡ç¿»è­¯è«‹åˆ†å…©è¡Œè¼¸å…¥ï¼‰"></textarea>
                    <input type="text" id="newQuoteAuthor" placeholder="ä½œè€…ï¼ˆå¿…å¡«ï¼‰" style="margin-top:8px;">
                    <button class="btn btn-primary btn-block" style="margin-top: 10px;" id="addQuoteBtn">â• æ–°å¢</button>
                </div>
                <div class="tab-content" id="tabBulkImport">
                    <p class="input-hint" style="margin-bottom: 8px;">
                        æ ¼å¼ï¼šåè¨€|ä½œè€…ï¼ˆä¸€è¡Œä¸€å¥ï¼‰<br>
                        ä¾‹ï¼šStay hungry. æ±‚çŸ¥è‹¥é£¢ã€‚|Steve Jobs è³ˆä¼¯æ–¯
                    </p>
                    <textarea id="bulkImportText" class="bulk-import-area" placeholder="è²¼ä¸Šå¤šç­†åè¨€..."></textarea>
                    <button class="btn btn-primary btn-block" style="margin-top: 10px;" id="bulkImportBtn">ğŸ“¥ åŒ¯å…¥</button>
                </div>
                <div class="tab-content" id="tabManageQuotes">
                    <div class="quote-list-header">
                        <input type="text" id="searchQuote" placeholder="ğŸ” æœå°‹...">
                    </div>
                    <div class="quote-list" id="quoteList"></div>
                    <p class="input-hint" id="quoteCount">å…± 0 å‰‡</p>
                    <button class="btn btn-secondary btn-block restore-all-btn" id="restoreAllBtn" style="display:none;">ğŸ”„ æ¢å¾©æ‰€æœ‰éš±è—çš„åè¨€</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="section-title"><span>ğŸ’¾</span> å‚™ä»½èˆ‡é‚„åŸ</div>
                <div class="backup-info">
                    <strong>ğŸ“¤ åŒ¯å‡ºå‚™ä»½</strong><br>
                    ä¸‹è¼‰ .json æª”æ¡ˆï¼ŒåŒ…å«æ‰€æœ‰è¨­å®šã€é¡˜æœ›ã€åè¨€ã€åœ–ç‰‡ã€‚<br><br>
                    <strong>ğŸ“¥ åŒ¯å…¥å‚™ä»½</strong><br>
                    é¸æ“‡ä¹‹å‰åŒ¯å‡ºçš„ .json æª”æ¡ˆï¼Œé‚„åŸæ‰€æœ‰è³‡æ–™ã€‚<br><br>
                    <strong>ğŸ’¡ ç”¨é€”</strong>ï¼šæ›æ‰‹æ©Ÿã€å®šæœŸå‚™ä»½æ™‚ä½¿ç”¨ã€‚
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="exportBtn">ğŸ“¤ åŒ¯å‡º</button>
                    <button class="btn btn-secondary" id="importBtn">ğŸ“¥ åŒ¯å…¥</button>
                </div>
                <input type="file" accept=".json" id="importFile" class="hidden-input">
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯åè¨€å½ˆçª— -->
    <div class="edit-modal" id="editModal">
        <div class="edit-modal-content">
            <div class="edit-modal-title">âœï¸ ç·¨è¼¯åè¨€</div>
            <textarea id="editQuoteText" placeholder="åè¨€å…§å®¹..."></textarea>
            <input type="text" id="editQuoteAuthor" placeholder="ä½œè€…">
            <div class="edit-modal-btns">
                <button class="btn btn-cancel" id="cancelEditBtn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveEditBtn">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ…¶ç¥å‹•ç•« -->
    <div class="celebration-overlay" id="celebrationOverlay">
        <div class="celebration-card">
            <div class="celebration-emoji" id="celebrationEmoji">ğŸ‰</div>
            <div class="celebration-title" id="celebrationTitle">æ­å–œï¼</div>
            <div class="celebration-message" id="celebrationMessage">é”æˆé‡Œç¨‹ç¢‘ï¼</div>
            <button class="btn btn-primary" id="closeCelebrationBtn">å¤ªæ£’äº†ï¼</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const defaultQuotesOriginal = [
            { text: "äººç”Ÿå¦‚é€†æ—…ï¼Œæˆ‘äº¦æ˜¯è¡Œäººã€‚", author: "è˜‡è»¾" },
            { text: "æ­¤å¿ƒå®‰è™•æ˜¯å¾é„‰ã€‚", author: "è˜‡è»¾" },
            { text: "è¡Œåˆ°æ°´çª®è™•ï¼Œåçœ‹é›²èµ·æ™‚ã€‚", author: "ç‹ç¶­" },
            { text: "æ¡èŠæ±ç±¬ä¸‹ï¼Œæ‚ ç„¶è¦‹å—å±±ã€‚", author: "é™¶æ·µæ˜" },
            { text: "ä¸ä»¥ç‰©å–œï¼Œä¸ä»¥å·±æ‚²ã€‚", author: "èŒƒä»²æ·¹" },
            { text: "é•·é¢¨ç ´æµªæœƒæœ‰æ™‚ï¼Œç›´æ›é›²å¸†æ¿Ÿæ»„æµ·ã€‚", author: "æç™½" },
            { text: "å¤©ç”Ÿæˆ‘æå¿…æœ‰ç”¨ã€‚", author: "æç™½" },
            { text: "å±±é‡æ°´è¤‡ç–‘ç„¡è·¯ï¼ŒæŸ³æš—èŠ±æ˜åˆä¸€æ‘ã€‚", author: "é™¸æ¸¸" },
            { text: "ä¸Šå–„è‹¥æ°´ï¼Œæ°´å–„åˆ©è¬ç‰©è€Œä¸çˆ­ã€‚", author: "è€å­ã€Šé“å¾·ç¶“ã€‹" },
            { text: "åƒé‡Œä¹‹è¡Œï¼Œå§‹æ–¼è¶³ä¸‹ã€‚", author: "è€å­ã€Šé“å¾·ç¶“ã€‹" },
            { text: "ç›¸æ¿¡ä»¥æ²«ï¼Œä¸å¦‚ç›¸å¿˜æ–¼æ±Ÿæ¹–ã€‚", author: "èŠå­" },
            { text: "ä¸‰åè€Œç«‹ï¼Œå››åè€Œä¸æƒ‘ï¼Œäº”åè€ŒçŸ¥å¤©å‘½ã€‚", author: "å­”å­ã€Šè«–èªã€‹" },
            { text: "å·±æ‰€ä¸æ¬²ï¼Œå‹¿æ–½æ–¼äººã€‚", author: "å­”å­ã€Šè«–èªã€‹" },
            { text: "çª®å‰‡ç¨å–„å…¶èº«ï¼Œé”å‰‡å…¼å–„å¤©ä¸‹ã€‚", author: "å­Ÿå­" },
            { text: "æ˜¥æœ‰ç™¾èŠ±ç§‹æœ‰æœˆï¼Œå¤æœ‰æ¶¼é¢¨å†¬æœ‰é›ªã€‚\nè‹¥ç„¡é–’äº‹æ›å¿ƒé ­ï¼Œä¾¿æ˜¯äººé–“å¥½æ™‚ç¯€ã€‚", author: "ç„¡é–€æ…§é–‹" },
            { text: "æ‡‰ç„¡æ‰€ä½è€Œç”Ÿå…¶å¿ƒã€‚", author: "ã€Šé‡‘å‰›ç¶“ã€‹" },
            { text: "å¯µè¾±ä¸é©šï¼Œçœ‹åº­å‰èŠ±é–‹èŠ±è½ï¼›\nå»ç•™ç„¡æ„ï¼Œæœ›å¤©ä¸Šé›²å·é›²èˆ’ã€‚", author: "æ´ªæ‡‰æ˜ã€Šèœæ ¹è­šã€‹" },
            { text: "äººç”Ÿä¸å¦‚æ„äº‹åä¹‹å…«ä¹ï¼Œå¸¸æƒ³ä¸€äºŒï¼Œä¸æ€å…«ä¹ã€‚", author: "æ—æ¸…ç„" },
            { text: "The only true wisdom is in knowing you know nothing.\nçœŸæ­£çš„æ™ºæ…§ï¼Œæ˜¯çŸ¥é“è‡ªå·±ä¸€ç„¡æ‰€çŸ¥ã€‚", author: "Socrates è˜‡æ ¼æ‹‰åº•" },
            { text: "Your time is limited, don't waste it living someone else's life.\nä½ çš„æ™‚é–“æœ‰é™ï¼Œä¸è¦æµªè²»æ™‚é–“éåˆ¥äººçš„ç”Ÿæ´»ã€‚", author: "Steve Jobs è³ˆä¼¯æ–¯" },
            { text: "Stay hungry, stay foolish.\næ±‚çŸ¥è‹¥é£¢ï¼Œè™›å¿ƒè‹¥æ„šã€‚", author: "Steve Jobs è³ˆä¼¯æ–¯" },
            { text: "The best investment you can make is in yourself.\næœ€å¥½çš„æŠ•è³‡ï¼Œæ˜¯æŠ•è³‡è‡ªå·±ã€‚", author: "Warren Buffett å·´è²ç‰¹" },
            { text: "The wound is the place where the Light enters you.\nå‚·å£æ˜¯å…‰é€²å…¥ä½ çš„åœ°æ–¹ã€‚", author: "Rumi é­¯ç±³" },
            { text: "What you seek is seeking you.\nä½ å°‹æ‰¾çš„ï¼Œä¹Ÿåœ¨å°‹æ‰¾ä½ ã€‚", author: "Rumi é­¯ç±³" },
            { text: "In a world deluged by irrelevant information, clarity is power.\nåœ¨å……æ–¥ç„¡é—œè³‡è¨Šçš„ä¸–ç•Œï¼Œæ¸…æ™°å°±æ˜¯åŠ›é‡ã€‚", author: "Yuval Harari å“ˆæ‹‰ç‘" },
            { text: "Be the change you wish to see in the world.\næˆç‚ºä½ æƒ³åœ¨ä¸–ç•Œä¸Šçœ‹åˆ°çš„æ”¹è®Šã€‚", author: "Gandhi ç”˜åœ°" },
            { text: "Be yourself; everyone else is already taken.\nåšä½ è‡ªå·±ï¼Œå› ç‚ºåˆ¥äººéƒ½æœ‰äººåšäº†ã€‚", author: "Oscar Wilde ç‹çˆ¾å¾·" },
            { text: "It is never too late to be what you might have been.\næˆç‚ºä½ å¯èƒ½æˆç‚ºçš„äººï¼Œæ°¸é ä¸å«Œé²ã€‚", author: "George Eliot å–¬æ²»Â·è‰¾ç•¥ç‰¹" }
        ];

        const defaultImagesOriginal = [
            "https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?w=800",
            "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800",
            "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800",
            "https://images.unsplash.com/photo-1519046904884-53103b34b206?w=800"
        ];

        const milestones = [
            { days: 1, emoji: "ğŸŠ", title: "æ˜å¤©å°±è‡ªç”±äº†ï¼", message: "æœ€å¾Œä¸€å¤©ï¼" },
            { days: 7, emoji: "ğŸŒŸ", title: "å€’æ•¸ä¸€é€±ï¼", message: "åªå‰©ä¸ƒå¤©ï¼" },
            { days: 30, emoji: "ğŸ“…", title: "å€’æ•¸ä¸€å€‹æœˆï¼", message: "ä¸‰åå¤©å¾Œå°±è‡ªç”±äº†ï¼" },
            { days: 100, emoji: "ğŸ’¯", title: "å€’æ•¸ 100 å¤©ï¼", message: "å¿«äº†ï¼" },
            { days: 365, emoji: "ğŸ—“ï¸", title: "å€’æ•¸ä¸€å¹´ï¼", message: "ä¸€å¹´å¾Œå°±è‡ªç”±äº†ï¼" }
        ];

        let settings = {
            retirementDate: "2028-02-10",
            startDate: new Date().toISOString().split('T')[0],
            bgMode: "daily",
            selectedImage: null,
            noBackground: false,
            customQuotes: [],
            customImages: [],
            wishlist: [],
            darkMode: false,
            celebratedMilestones: [],
            customTitle: "Kolyaè‡ªç”±å€’æ•¸",
            editedDefaultQuotes: {},
            hiddenDefaultQuotes: [],
            deletedDefaultQuotes: [],
            deletedDefaultImages: []
        };

        let quoteEditMode = false;
        let editingQuoteType = null;
        let editingQuoteIndex = -1;
        let dragType = null;
        let dragData = null;
        let autoScrollInterval = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            migrateData();
            applyTheme();
            updateTitle();
            updateCountdown();
            updateQuote();
            updateBackground();
            updateImageList();
            updateQuoteList();
            updateWishList();
            updateStorageInfo();
            setupEventListeners();
            checkMilestoneCelebration();
            setInterval(updateCountdown, 60000);
        });

        function migrateData() {
            if (settings.wishlist.length > 0 && settings.wishlist[0] && !settings.wishlist[0].hasOwnProperty('subItems')) {
                settings.wishlist = settings.wishlist.map((item, i) => ({
                    id: Date.now() + i,
                    text: typeof item === 'string' ? item : item.text,
                    completed: typeof item === 'object' ? item.completed : false,
                    expanded: false,
                    subItems: []
                }));
                saveSettings();
            }
            if (!settings.deletedDefaultImages) settings.deletedDefaultImages = [];
            if (settings.noBackground === undefined) settings.noBackground = false;
        }

        function loadSettings() {
            const saved = localStorage.getItem('kolyaFreedomCountdown');
            if (saved) settings = { ...settings, ...JSON.parse(saved) };
            document.getElementById('retirementDate').value = settings.retirementDate;
            document.getElementById('customTitle').value = settings.customTitle || 'Kolyaè‡ªç”±å€’æ•¸';
            const modeMap = { daily: 'modeDaily', random: 'modeRandom', fixed: 'modeFixed' };
            document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('active'));
            document.getElementById(modeMap[settings.bgMode])?.classList.add('active');
            if (settings.darkMode) document.getElementById('themeToggle').classList.add('active');
        }

        function saveSettings() { localStorage.setItem('kolyaFreedomCountdown', JSON.stringify(settings)); }
        function applyTheme() { document.documentElement.setAttribute('data-theme', settings.darkMode ? 'dark' : 'light'); }
        function updateTitle() { document.getElementById('titleText').textContent = settings.customTitle || 'Kolyaè‡ªç”±å€’æ•¸'; }

        function toggleTheme() {
            settings.darkMode = !settings.darkMode;
            saveSettings();
            applyTheme();
            document.getElementById('themeToggle').classList.toggle('active');
            showToast(settings.darkMode ? 'æ·±è‰²æ¨¡å¼ ğŸŒ™' : 'æ·ºè‰²æ¨¡å¼ â˜€ï¸');
        }

        function updateCountdown() {
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const targetDate = new Date(settings.retirementDate); targetDate.setHours(0, 0, 0, 0);
            const startDate = new Date(settings.startDate); startDate.setHours(0, 0, 0, 0);
            
            document.getElementById('targetDate').textContent = `ç›®æ¨™ï¼š${targetDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}`;
            
            const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            document.getElementById('daysRemaining').textContent = diffDays > 0 ? diffDays : 'ğŸ‰';
            
            if (diffDays > 0) {
                document.getElementById('yearsRemaining').textContent = Math.floor(diffDays / 365);
                document.getElementById('monthsRemaining').textContent = Math.floor(diffDays / 30);
                document.getElementById('weeksRemaining').textContent = Math.floor(diffDays / 7);
                document.getElementById('workdaysRemaining').textContent = calculateWorkdays(today, targetDate);
            }
            
            let progress = Math.max(0, Math.min(100, ((today - startDate) / (targetDate - startDate)) * 100));
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = `å·²å®Œæˆ ${progress.toFixed(1)}%`;
            
            showMilestoneIndicator(diffDays);
        }

        function calculateWorkdays(start, end) {
            let count = 0;
            const current = new Date(start);
            while (current < end) {
                if (current.getDay() !== 0 && current.getDay() !== 6) count++;
                current.setDate(current.getDate() + 1);
            }
            return count;
        }

        function showMilestoneIndicator(days) {
            const el = document.getElementById('milestone');
            const m = milestones.find(m => m.days === days);
            if (m) { el.textContent = `${m.emoji} ${m.title}`; el.style.display = 'block'; }
            else { el.style.display = 'none'; }
        }

        function checkMilestoneCelebration() {
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const targetDate = new Date(settings.retirementDate); targetDate.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            const m = milestones.find(m => m.days === diffDays);
            const todayStr = today.toISOString().split('T')[0];
            
            if (m && !settings.celebratedMilestones.includes(`${m.days}-${todayStr}`)) {
                showCelebration(m);
                settings.celebratedMilestones.push(`${m.days}-${todayStr}`);
                saveSettings();
            }
        }

        function showCelebration(m) {
            document.getElementById('celebrationEmoji').textContent = m.emoji;
            document.getElementById('celebrationTitle').textContent = m.title;
            document.getElementById('celebrationMessage').textContent = m.message;
            document.getElementById('celebrationOverlay').classList.add('show');
            createConfetti();
        }

        function createConfetti() {
            const colors = ['#C9A962', '#4A8B8B', '#8B7355', '#7FB3B3', '#2C5F5D'];
            for (let i = 0; i < 40; i++) {
                setTimeout(() => {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.background = colors[Math.floor(Math.random() * colors.length)];
                    c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 4000);
                }, i * 50);
            }
        }

        // ===== åè¨€ =====
        function getActiveQuotes() {
            const quotes = [];
            defaultQuotesOriginal.forEach((q, i) => {
                if (!settings.deletedDefaultQuotes?.includes(i) && !settings.hiddenDefaultQuotes?.includes(i)) {
                    quotes.push(settings.editedDefaultQuotes?.[i] || q);
                }
            });
            settings.customQuotes.forEach(q => quotes.push(q));
            return quotes;
        }

        function formatQuoteText(text) {
            if (text.includes('\n')) {
                const lines = text.split('\n');
                return `ã€Œ${lines[0]}ã€<span class="quote-translation">${lines.slice(1).join(' ')}</span>`;
            }
            const match = text.match(/^([A-Za-z][^ã€‚ï¼ï¼Ÿ]*[.!?])\s*(.+)$/);
            if (match && /[\u4e00-\u9fff]/.test(match[2])) {
                return `ã€Œ${match[1]}ã€<span class="quote-translation">${match[2]}</span>`;
            }
            return `ã€Œ${text}ã€`;
        }

        function updateQuote() {
            const quotes = getActiveQuotes();
            if (quotes.length === 0) {
                document.getElementById('quoteText').innerHTML = 'ã€Œç„¡åè¨€å¯é¡¯ç¤ºã€';
                document.getElementById('quoteAuthor').textContent = '';
                return;
            }
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const q = quotes[dayOfYear % quotes.length];
            document.getElementById('quoteText').innerHTML = formatQuoteText(q.text);
            document.getElementById('quoteAuthor').textContent = `â€” ${q.author}`;
        }

        // ===== åœ–ç‰‡ =====
        function getActiveImages() {
            const images = [];
            defaultImagesOriginal.forEach((url, i) => {
                if (!settings.deletedDefaultImages?.includes(i)) {
                    images.push({ url, type: 'default', index: i });
                }
            });
            settings.customImages.forEach((url, i) => {
                images.push({ url, type: 'custom', index: i });
            });
            return images;
        }

        function updateBackground() {
            const bgLayer = document.getElementById('bgLayer');
            
            if (settings.noBackground) {
                bgLayer.classList.add('no-bg');
                bgLayer.style.backgroundImage = 'none';
                return;
            }
            
            bgLayer.classList.remove('no-bg');
            
            const images = getActiveImages();
            if (images.length === 0) {
                bgLayer.style.backgroundImage = 'none';
                return;
            }
            
            let url;
            switch (settings.bgMode) {
                case 'daily':
                    const today = new Date();
                    const day = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                    url = images[day % images.length].url;
                    break;
                case 'random':
                    url = images[Math.floor(Math.random() * images.length)].url;
                    break;
                case 'fixed':
                    url = settings.selectedImage || images[0].url;
                    break;
            }
            bgLayer.style.backgroundImage = `url(${url})`;
        }

        function updateImageList() {
            const container = document.getElementById('imageList');
            let html = '';
            
            // ç„¡èƒŒæ™¯é¸é …
            html += `
                <div class="image-item no-bg-option ${settings.noBackground ? 'selected' : ''}" onclick="selectNoBackground()">
                    ğŸš«<br>ç„¡èƒŒæ™¯
                </div>
            `;
            
            // é è¨­åœ–ç‰‡
            defaultImagesOriginal.forEach((url, i) => {
                const isDeleted = settings.deletedDefaultImages?.includes(i);
                if (isDeleted) return;
                
                const isSelected = !settings.noBackground && settings.selectedImage === url;
                
                html += `
                    <div class="image-item ${isSelected ? 'selected' : ''}" data-url="${url}" data-type="default" data-index="${i}" id="img-default-${i}">
                        <img src="${url}" alt="èƒŒæ™¯ ${i+1}" onload="this.parentElement.dataset.loaded='true'" onerror="handleImageError(this, 'default', ${i})">
                        <div class="img-error" style="display:none;"><span class="error-icon">âš ï¸</span>è¼‰å…¥å¤±æ•—</div>
                        <div class="img-actions">
                            <button class="img-action-btn select" onclick="event.stopPropagation(); selectImage('${url}')" title="è¨­ç‚ºèƒŒæ™¯">âœ“</button>
                            <button class="img-action-btn delete" onclick="event.stopPropagation(); deleteDefaultImage(${i})" title="åˆªé™¤">âœ•</button>
                        </div>
                    </div>
                `;
            });
            
            // è‡ªè¨‚åœ–ç‰‡
            settings.customImages.forEach((url, i) => {
                const isSelected = !settings.noBackground && settings.selectedImage === url;
                
                html += `
                    <div class="image-item ${isSelected ? 'selected' : ''}" data-url="${url}" data-type="custom" data-index="${i}" id="img-custom-${i}">
                        <img src="${url}" alt="è‡ªè¨‚èƒŒæ™¯ ${i+1}" onload="this.parentElement.dataset.loaded='true'" onerror="handleImageError(this, 'custom', ${i})">
                        <div class="img-error" style="display:none;"><span class="error-icon">âš ï¸</span>è¼‰å…¥å¤±æ•—</div>
                        <div class="img-actions">
                            <button class="img-action-btn select" onclick="event.stopPropagation(); selectImage('${url}')" title="è¨­ç‚ºèƒŒæ™¯">âœ“</button>
                            <button class="img-action-btn delete" onclick="event.stopPropagation(); deleteCustomImage(${i})" title="åˆªé™¤">âœ•</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function handleImageError(img, type, index) {
            img.style.display = 'none';
            img.nextElementSibling.style.display = 'flex';
            const item = img.parentElement;
            item.classList.add('error-item');
            
            // é‡æ–°è¨­ç½®æ“ä½œæŒ‰éˆ•ï¼Œåªä¿ç•™åˆªé™¤
            const actionsDiv = item.querySelector('.img-actions');
            if (type === 'default') {
                actionsDiv.innerHTML = `<button class="img-action-btn delete" onclick="event.stopPropagation(); deleteDefaultImage(${index})" title="åˆªé™¤">âœ•</button>`;
            } else {
                actionsDiv.innerHTML = `<button class="img-action-btn delete" onclick="event.stopPropagation(); deleteCustomImage(${index})" title="åˆªé™¤">âœ•</button>`;
            }
        }

        function selectNoBackground() {
            settings.noBackground = true;
            settings.selectedImage = null;
            saveSettings();
            updateBackground();
            updateImageList();
            showToast('å·²è¨­ç‚ºç„¡èƒŒæ™¯ âœ“');
        }

        function selectImage(url) {
            settings.noBackground = false;
            settings.selectedImage = url;
            settings.bgMode = 'fixed';
            saveSettings();
            updateBackground();
            updateImageList();
            document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('active'));
            document.getElementById('modeFixed').classList.add('active');
            showToast('å·²è¨­ç‚ºèƒŒæ™¯ âœ“');
        }

        function deleteDefaultImage(index) {
            if (!settings.deletedDefaultImages) settings.deletedDefaultImages = [];
            settings.deletedDefaultImages.push(index);
            saveSettings();
            updateImageList();
            updateBackground();
            showToast('å·²åˆªé™¤ âœ“');
        }

        function deleteCustomImage(index) {
            settings.customImages.splice(index, 1);
            saveSettings();
            updateImageList();
            updateBackground();
            updateStorageInfo();
            showToast('å·²åˆªé™¤ âœ“');
        }

        // ===== åè¨€ç®¡ç† =====
        function updateQuoteList(filter = '') {
            const container = document.getElementById('quoteList');
            let html = '';
            
            defaultQuotesOriginal.forEach((originalQ, i) => {
                const isDeleted = settings.deletedDefaultQuotes?.includes(i);
                const isHidden = settings.hiddenDefaultQuotes?.includes(i);
                const edited = settings.editedDefaultQuotes?.[i];
                const q = edited || originalQ;
                
                if (isDeleted) return;
                if (filter && !q.text.includes(filter) && !q.author.includes(filter)) return;
                
                html += `
                    <div class="quote-item ${isHidden ? 'hidden-quote' : ''}">
                        <div class="quote-item-text">${q.text.replace(/\n/g, '<br>')}</div>
                        <div class="quote-item-author">â€” ${q.author} ${isHidden ? '(å·²éš±è—)' : ''}</div>
                        <div class="quote-item-actions ${quoteEditMode ? 'show' : ''}">
                            <button class="quote-action-btn edit" onclick="openEditModal('default', ${i})" title="ç·¨è¼¯">âœï¸</button>
                            ${isHidden 
                                ? `<button class="quote-action-btn restore" onclick="restoreQuote(${i})" title="æ¢å¾©">ğŸ”„</button>`
                                : `<button class="quote-action-btn hide" onclick="hideQuote(${i})" title="éš±è—">ğŸ‘ï¸</button>`
                            }
                            <button class="quote-action-btn delete" onclick="deleteDefaultQuote(${i})" title="åˆªé™¤">âœ•</button>
                        </div>
                    </div>
                `;
            });
            
            settings.customQuotes.forEach((q, i) => {
                if (filter && !q.text.includes(filter) && !q.author.includes(filter)) return;
                
                html += `
                    <div class="quote-item">
                        <div class="quote-item-text">${q.text.replace(/\n/g, '<br>')}</div>
                        <div class="quote-item-author">â€” ${q.author} (è‡ªè¨‚)</div>
                        <div class="quote-item-actions ${quoteEditMode ? 'show' : ''}">
                            <button class="quote-action-btn edit" onclick="openEditModal('custom', ${i})" title="ç·¨è¼¯">âœï¸</button>
                            <button class="quote-action-btn delete" onclick="deleteCustomQuote(${i})" title="åˆªé™¤">âœ•</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="empty-state"><span>ğŸ”</span>æ‰¾ä¸åˆ°</div>';
            
            const activeCount = getActiveQuotes().length;
            const hiddenCount = settings.hiddenDefaultQuotes?.length || 0;
            document.getElementById('quoteCount').textContent = `é¡¯ç¤º ${activeCount} å‰‡${hiddenCount > 0 ? `ï¼Œéš±è— ${hiddenCount} å‰‡` : ''}`;
            document.getElementById('restoreAllBtn').style.display = hiddenCount > 0 ? 'block' : 'none';
        }

        function updateQuoteEditButtons() {
            const btnGroup = document.getElementById('quoteEditBtnGroup');
            if (quoteEditMode) {
                btnGroup.innerHTML = `
                    <button class="btn btn-primary" id="quoteSaveBtn">ğŸ’¾ å„²å­˜</button>
                    <button class="btn btn-cancel" id="quoteCancelBtn">å–æ¶ˆ</button>
                `;
                document.getElementById('quoteSaveBtn').addEventListener('click', () => {
                    quoteEditMode = false;
                    updateQuoteEditButtons();
                    updateQuoteList(document.getElementById('searchQuote').value);
                    showToast('å·²å„²å­˜ âœ“');
                });
                document.getElementById('quoteCancelBtn').addEventListener('click', () => {
                    quoteEditMode = false;
                    updateQuoteEditButtons();
                    updateQuoteList(document.getElementById('searchQuote').value);
                });
            } else {
                btnGroup.innerHTML = `<button class="btn btn-secondary" id="quoteEditBtn">âœï¸ ç·¨è¼¯</button>`;
                document.getElementById('quoteEditBtn').addEventListener('click', () => {
                    quoteEditMode = true;
                    updateQuoteEditButtons();
                    updateQuoteList(document.getElementById('searchQuote').value);
                });
            }
        }

        function openEditModal(type, index) {
            editingQuoteType = type;
            editingQuoteIndex = index;
            
            let q = type === 'default' 
                ? (settings.editedDefaultQuotes?.[index] || defaultQuotesOriginal[index])
                : settings.customQuotes[index];
            
            document.getElementById('editQuoteText').value = q.text;
            document.getElementById('editQuoteAuthor').value = q.author;
            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        function saveEditQuote() {
            const text = document.getElementById('editQuoteText').value.trim();
            const author = document.getElementById('editQuoteAuthor').value.trim();
            
            if (!text || !author) { showToast('è«‹å¡«å¯«å®Œæ•´'); return; }
            
            if (editingQuoteType === 'default') {
                if (!settings.editedDefaultQuotes) settings.editedDefaultQuotes = {};
                settings.editedDefaultQuotes[editingQuoteIndex] = { text, author };
            } else {
                settings.customQuotes[editingQuoteIndex] = { text, author };
            }
            
            saveSettings();
            updateQuoteList(document.getElementById('searchQuote').value);
            updateQuote();
            closeEditModal();
            showToast('å·²å„²å­˜ âœ“');
        }

        function hideQuote(index) {
            if (!settings.hiddenDefaultQuotes) settings.hiddenDefaultQuotes = [];
            if (!settings.hiddenDefaultQuotes.includes(index)) {
                settings.hiddenDefaultQuotes.push(index);
                saveSettings();
                updateQuoteList(document.getElementById('searchQuote').value);
                updateQuote();
                showToast('å·²éš±è— âœ“');
            }
        }

        function restoreQuote(index) {
            settings.hiddenDefaultQuotes = settings.hiddenDefaultQuotes?.filter(i => i !== index) || [];
            saveSettings();
            updateQuoteList(document.getElementById('searchQuote').value);
            updateQuote();
            showToast('å·²æ¢å¾© âœ“');
        }

        function restoreAllQuotes() {
            settings.hiddenDefaultQuotes = [];
            saveSettings();
            updateQuoteList(document.getElementById('searchQuote').value);
            updateQuote();
            showToast('å·²æ¢å¾©æ‰€æœ‰ âœ“');
        }

        function deleteDefaultQuote(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡åè¨€å—ï¼Ÿ')) {
                if (!settings.deletedDefaultQuotes) settings.deletedDefaultQuotes = [];
                settings.deletedDefaultQuotes.push(index);
                settings.hiddenDefaultQuotes = settings.hiddenDefaultQuotes?.filter(i => i !== index) || [];
                saveSettings();
                updateQuoteList(document.getElementById('searchQuote').value);
                updateQuote();
                showToast('å·²åˆªé™¤ âœ“');
            }
        }

        function deleteCustomQuote(index) {
            settings.customQuotes.splice(index, 1);
            saveSettings();
            updateQuoteList(document.getElementById('searchQuote').value);
            updateQuote();
            updateStorageInfo();
            showToast('å·²åˆªé™¤ âœ“');
        }

        function bulkImportQuotes() {
            const text = document.getElementById('bulkImportText').value.trim();
            if (!text) { showToast('è«‹è¼¸å…¥åè¨€'); return; }
            let imported = 0;
            text.split('\n').filter(l => l.trim()).forEach(line => {
                const parts = line.split('|');
                if (parts.length >= 2 && parts[0].trim() && parts[1].trim()) {
                    settings.customQuotes.push({ text: parts[0].trim(), author: parts[1].trim() });
                    imported++;
                }
            });
            if (imported > 0) {
                saveSettings();
                updateQuoteList();
                updateStorageInfo();
                document.getElementById('bulkImportText').value = '';
                showToast(`åŒ¯å…¥ ${imported} å‰‡ âœ“`);
            } else {
                showToast('æ ¼å¼éŒ¯èª¤');
            }
        }

        // ===== é¡˜æœ›æ¸…å–® =====
        function updateWishList() {
            const container = document.getElementById('wishList');
            
            if (settings.wishlist.length === 0) {
                container.innerHTML = '<div class="empty-state"><span>ğŸ“</span>é‚„æ²’æœ‰é¡˜æœ›<br>æ–°å¢ä¸€å€‹å§ï¼</div>';
                return;
            }
            
            let html = '<div class="drop-zone" data-target="parent" data-index="0"></div>';
            
            settings.wishlist.forEach((wish, idx) => {
                html += `
                    <div class="wish-group" data-index="${idx}">
                        <div class="wish-parent">
                            <span class="drag-handle" draggable="true" data-type="parent" data-index="${idx}">â˜°</span>
                            <div class="wish-checkbox ${wish.completed ? 'checked' : ''}" onclick="toggleWish(${idx})">${wish.completed ? 'âœ“' : ''}</div>
                            <span class="wish-text ${wish.completed ? 'completed' : ''}" onclick="editWishText(${idx}, 'parent')" id="wish-text-${idx}">${wish.text}</span>
                            <div class="wish-actions">
                                <button class="wish-action-btn expand-btn ${wish.expanded ? 'expanded' : ''}" onclick="toggleExpand(${idx})">â–¼</button>
                                <button class="wish-action-btn delete" onclick="deleteWish(${idx})">Ã—</button>
                            </div>
                        </div>
                        <div class="sub-wishes ${wish.expanded ? 'show' : ''}" id="sub-${idx}">
                            <div class="sub-drop-zone" data-target="sub" data-parent="${idx}" data-index="0"></div>
                            ${(wish.subItems || []).map((sub, subIdx) => `
                                <div class="sub-wish-item" data-parent="${idx}" data-sub="${subIdx}">
                                    <span class="drag-handle-sub" draggable="true" data-type="sub" data-parent="${idx}" data-index="${subIdx}">â‹®â‹®</span>
                                    <div class="wish-checkbox ${sub.completed ? 'checked' : ''}" onclick="toggleSubWish(${idx}, ${subIdx})">${sub.completed ? 'âœ“' : ''}</div>
                                    <span class="wish-text ${sub.completed ? 'completed' : ''}" onclick="editWishText(${idx}, 'sub', ${subIdx})" id="wish-text-${idx}-${subIdx}">${sub.text}</span>
                                    <button class="wish-action-btn delete" onclick="deleteSubWish(${idx}, ${subIdx})">Ã—</button>
                                </div>
                                <div class="sub-drop-zone" data-target="sub" data-parent="${idx}" data-index="${subIdx + 1}"></div>
                            `).join('')}
                            <div class="add-sub-wish" onclick="showSubWishInput(${idx})">
                                <span style="margin-right:5px;">ï¼‹</span> æ–°å¢å­é …ç›®
                            </div>
                            <div id="sub-input-${idx}" style="display:none; padding: 8px 0;">
                                <div style="display:flex; gap:8px;">
                                    <input type="text" style="flex:1; padding:8px; border:1px solid var(--sand-warm); border-radius:6px; font-size:0.9rem;" id="sub-text-${idx}" placeholder="å­é …ç›®..." onkeypress="if(event.key==='Enter')addSubWish(${idx})">
                                    <button class="btn btn-primary btn-small" onclick="addSubWish(${idx})">â•</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="drop-zone" data-target="parent" data-index="${idx + 1}"></div>
                `;
            });
            
            container.innerHTML = html;
            setupDragAndDrop();
            
            const total = settings.wishlist.length;
            const completed = settings.wishlist.filter(w => w.completed).length;
            const subTotal = settings.wishlist.reduce((sum, w) => sum + (w.subItems?.length || 0), 0);
            document.getElementById('wishCount').textContent = `${total} å€‹é¡˜æœ›ï¼Œ${subTotal} å€‹å­é …ç›®ï¼Œå·²å®Œæˆ ${completed}`;
        }

        function editWishText(parentIdx, type, subIdx) {
            let currentText, elementId;
            
            if (type === 'parent') {
                currentText = settings.wishlist[parentIdx].text;
                elementId = `wish-text-${parentIdx}`;
            } else {
                currentText = settings.wishlist[parentIdx].subItems[subIdx].text;
                elementId = `wish-text-${parentIdx}-${subIdx}`;
            }
            
            const el = document.getElementById(elementId);
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'wish-text-input';
            input.value = currentText;
            
            el.replaceWith(input);
            input.focus();
            input.select();
            
            const save = () => {
                const newText = input.value.trim();
                if (newText) {
                    if (type === 'parent') {
                        settings.wishlist[parentIdx].text = newText;
                    } else {
                        settings.wishlist[parentIdx].subItems[subIdx].text = newText;
                    }
                    saveSettings();
                }
                updateWishList();
            };
            
            input.addEventListener('blur', save);
            input.addEventListener('keypress', (e) => { if (e.key === 'Enter') save(); });
        }

        function setupDragAndDrop() {
            const wishListContainer = document.getElementById('wishList');
            const scrollZoneTop = document.getElementById('scrollZoneTop');
            const scrollZoneBottom = document.getElementById('scrollZoneBottom');
            
            document.querySelectorAll('[draggable="true"]').forEach(handle => {
                handle.addEventListener('dragstart', handleDragStart);
                handle.addEventListener('dragend', handleDragEnd);
            });
            
            document.querySelectorAll('.drop-zone, .sub-drop-zone').forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragenter', handleDragEnter);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
            });
            
            const wrapper = document.querySelector('.wish-list-wrapper');
            if (wrapper) {
                wrapper.addEventListener('dragover', (e) => {
                    const rect = wrapper.getBoundingClientRect();
                    const y = e.clientY;
                    const threshold = 60;
                    
                    clearInterval(autoScrollInterval);
                    scrollZoneTop.classList.remove('active');
                    scrollZoneBottom.classList.remove('active');
                    
                    if (y < rect.top + threshold) {
                        scrollZoneTop.classList.add('active');
                        autoScrollInterval = setInterval(() => {
                            wishListContainer.scrollTop -= 15;
                        }, 30);
                    } else if (y > rect.bottom - threshold) {
                        scrollZoneBottom.classList.add('active');
                        autoScrollInterval = setInterval(() => {
                            wishListContainer.scrollTop += 15;
                        }, 30);
                    }
                });
            }
        }

        function handleDragStart(e) {
            dragType = this.dataset.type;
            dragData = {
                type: dragType,
                parentIndex: parseInt(this.dataset.parent || this.dataset.index),
                subIndex: dragType === 'sub' ? parseInt(this.dataset.index) : null
            };
            
            if (dragType === 'parent') {
                this.closest('.wish-group').classList.add('dragging');
            } else {
                this.closest('.sub-wish-item').classList.add('dragging');
            }
            
            document.querySelectorAll('.drop-zone, .sub-drop-zone').forEach(z => z.classList.add('active'));
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            dragType = null;
            dragData = null;
            clearInterval(autoScrollInterval);
            document.getElementById('scrollZoneTop')?.classList.remove('active');
            document.getElementById('scrollZoneBottom')?.classList.remove('active');
            document.querySelectorAll('.wish-group, .sub-wish-item').forEach(el => el.classList.remove('dragging'));
            document.querySelectorAll('.drop-zone, .sub-drop-zone').forEach(z => z.classList.remove('active'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            this.style.background = 'rgba(74, 139, 139, 0.3)';
        }

        function handleDragLeave(e) {
            this.style.background = '';
        }

        function handleDrop(e) {
            e.preventDefault();
            this.style.background = '';
            clearInterval(autoScrollInterval);
            
            if (!dragData) return;
            
            const targetType = this.dataset.target;
            const targetParent = parseInt(this.dataset.parent || -1);
            const targetIndex = parseInt(this.dataset.index);
            
            let draggedItem;
            if (dragData.type === 'parent') {
                draggedItem = settings.wishlist.splice(dragData.parentIndex, 1)[0];
            } else {
                draggedItem = settings.wishlist[dragData.parentIndex].subItems.splice(dragData.subIndex, 1)[0];
            }
            
            if (targetType === 'parent') {
                const newParent = {
                    id: Date.now(),
                    text: draggedItem.text,
                    completed: draggedItem.completed,
                    expanded: false,
                    subItems: draggedItem.subItems || []
                };
                
                let insertIdx = targetIndex;
                if (dragData.type === 'parent' && dragData.parentIndex < targetIndex) insertIdx--;
                
                settings.wishlist.splice(insertIdx, 0, newParent);
            } else {
                const newSub = { id: Date.now(), text: draggedItem.text, completed: draggedItem.completed };
                
                if (!settings.wishlist[targetParent].subItems) settings.wishlist[targetParent].subItems = [];
                
                let insertIdx = targetIndex;
                if (dragData.type === 'sub' && dragData.parentIndex === targetParent && dragData.subIndex < targetIndex) insertIdx--;
                
                settings.wishlist[targetParent].subItems.splice(insertIdx, 0, newSub);
                settings.wishlist[targetParent].expanded = true;
            }
            
            saveSettings();
            updateWishList();
            showToast('å·²èª¿æ•´ âœ“');
        }

        function addWish() {
            const input = document.getElementById('newWishInput');
            const text = input.value.trim();
            if (text) {
                settings.wishlist.push({ id: Date.now(), text, completed: false, expanded: false, subItems: [] });
                saveSettings();
                updateWishList();
                input.value = '';
                showToast('å·²æ–°å¢ âœ“');
            }
        }

        function toggleWish(idx) {
            const newState = !settings.wishlist[idx].completed;
            settings.wishlist[idx].completed = newState;
            if (newState && settings.wishlist[idx].subItems) {
                settings.wishlist[idx].subItems.forEach(sub => sub.completed = true);
            }
            saveSettings();
            updateWishList();
        }

        function deleteWish(idx) {
            settings.wishlist.splice(idx, 1);
            saveSettings();
            updateWishList();
            showToast('å·²åˆªé™¤ âœ“');
        }

        function toggleExpand(idx) {
            settings.wishlist[idx].expanded = !settings.wishlist[idx].expanded;
            saveSettings();
            updateWishList();
        }

        function showSubWishInput(idx) {
            const inputDiv = document.getElementById(`sub-input-${idx}`);
            inputDiv.style.display = inputDiv.style.display === 'none' ? 'block' : 'none';
            if (inputDiv.style.display === 'block') document.getElementById(`sub-text-${idx}`).focus();
        }

        function addSubWish(idx) {
            const input = document.getElementById(`sub-text-${idx}`);
            const text = input.value.trim();
            if (text) {
                if (!settings.wishlist[idx].subItems) settings.wishlist[idx].subItems = [];
                settings.wishlist[idx].subItems.push({ id: Date.now(), text, completed: false });
                settings.wishlist[idx].expanded = true;
                saveSettings();
                updateWishList();
                showToast('å·²æ–°å¢ âœ“');
            }
        }

        function toggleSubWish(parentIdx, subIdx) {
            settings.wishlist[parentIdx].subItems[subIdx].completed = !settings.wishlist[parentIdx].subItems[subIdx].completed;
            saveSettings();
            updateWishList();
        }

        function deleteSubWish(parentIdx, subIdx) {
            settings.wishlist[parentIdx].subItems.splice(subIdx, 1);
            saveSettings();
            updateWishList();
            showToast('å·²åˆªé™¤ âœ“');
        }

        // ===== åŒ¯å‡ºåŒ¯å…¥ =====
        function exportData() {
            const data = { version: 8, exportDate: new Date().toISOString(), settings };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Kolyaå‚™ä»½_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.json`;
            a.click();
            showToast('å·²ä¸‹è¼‰å‚™ä»½æª” âœ“');
        }

        function importData(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.settings) {
                        settings = { ...settings, ...data.settings };
                        saveSettings();
                        loadSettings();
                        migrateData();
                        applyTheme();
                        updateTitle();
                        updateCountdown();
                        updateQuote();
                        updateBackground();
                        updateImageList();
                        updateQuoteList();
                        updateWishList();
                        updateStorageInfo();
                        showToast('å·²é‚„åŸ âœ“');
                    }
                } catch (err) { showToast('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
            };
            reader.readAsText(file);
        }

        function updateStorageInfo() {
            const data = localStorage.getItem('kolyaFreedomCountdown') || '';
            const sizeKB = new Blob([data]).size / 1024;
            document.getElementById('storageInfo').textContent = `å·²ä½¿ç”¨ ${sizeKB.toFixed(1)} KB / 5120 KB`;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function setupEventListeners() {
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsPanel').classList.add('open');
                document.getElementById('overlay').classList.add('show');
            });
            
            document.getElementById('wishlistBtn').addEventListener('click', () => {
                document.getElementById('wishlistPanel').classList.add('open');
                document.getElementById('overlay').classList.add('show');
            });
            
            const closeAll = () => {
                document.getElementById('settingsPanel').classList.remove('open');
                document.getElementById('wishlistPanel').classList.remove('open');
                document.getElementById('overlay').classList.remove('show');
            };
            
            document.getElementById('closeBtn').addEventListener('click', closeAll);
            document.getElementById('closeWishlistBtn').addEventListener('click', closeAll);
            document.getElementById('overlay').addEventListener('click', closeAll);
            
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            document.getElementById('saveTitleBtn').addEventListener('click', () => {
                settings.customTitle = document.getElementById('customTitle').value.trim() || 'Kolyaè‡ªç”±å€’æ•¸';
                saveSettings();
                updateTitle();
                showToast('å·²æ›´æ–° âœ“');
            });
            
            document.getElementById('saveDateBtn').addEventListener('click', () => {
                settings.retirementDate = document.getElementById('retirementDate').value;
                settings.startDate = new Date().toISOString().split('T')[0];
                settings.celebratedMilestones = [];
                saveSettings();
                updateCountdown();
                checkMilestoneCelebration();
                showToast('å·²å„²å­˜ âœ“');
            });
            
            document.querySelectorAll('.mode-option').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.mode-option').forEach(e => e.classList.remove('active'));
                    el.classList.add('active');
                    settings.bgMode = el.querySelector('input').value;
                    settings.noBackground = false;
                    saveSettings();
                    updateBackground();
                    updateImageList();
                    showToast('å·²æ›´æ”¹ âœ“');
                });
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const group = tab.parentElement;
                    const content = group.parentElement;
                    const name = tab.dataset.tab;
                    group.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    content.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                    const target = document.getElementById('tab' + name.charAt(0).toUpperCase() + name.slice(1));
                    if (target) target.classList.add('active');
                });
            });
            
            document.getElementById('addUrlBtn').addEventListener('click', () => {
                const url = document.getElementById('imageUrl').value.trim();
                if (url) {
                    settings.customImages.push(url);
                    saveSettings();
                    updateImageList();
                    updateStorageInfo();
                    document.getElementById('imageUrl').value = '';
                    showToast('å·²æ–°å¢');
                }
            });
            
            document.getElementById('uploadBtn').addEventListener('click', () => document.getElementById('imageUpload').click());
            
            document.getElementById('imageUpload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        settings.customImages.push(ev.target.result);
                        saveSettings();
                        updateImageList();
                        updateStorageInfo();
                        showToast('å·²ä¸Šå‚³ âœ“');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            document.getElementById('quoteEditBtn').addEventListener('click', () => {
                quoteEditMode = true;
                updateQuoteEditButtons();
                updateQuoteList(document.getElementById('searchQuote').value);
            });
            
            document.getElementById('addQuoteBtn').addEventListener('click', () => {
                const text = document.getElementById('newQuoteText').value.trim();
                const author = document.getElementById('newQuoteAuthor').value.trim();
                if (text && author) {
                    settings.customQuotes.push({ text, author });
                    saveSettings();
                    updateQuoteList();
                    updateStorageInfo();
                    document.getElementById('newQuoteText').value = '';
                    document.getElementById('newQuoteAuthor').value = '';
                    showToast('å·²æ–°å¢ âœ“');
                } else {
                    showToast('è«‹å¡«å¯«å®Œæ•´');
                }
            });
            
            document.getElementById('bulkImportBtn').addEventListener('click', bulkImportQuotes);
            document.getElementById('searchQuote').addEventListener('input', (e) => updateQuoteList(e.target.value));
            document.getElementById('restoreAllBtn').addEventListener('click', restoreAllQuotes);
            
            document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
            document.getElementById('saveEditBtn').addEventListener('click', saveEditQuote);
            document.getElementById('editModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('editModal')) closeEditModal();
            });
            
            document.getElementById('addWishBtn').addEventListener('click', addWish);
            document.getElementById('newWishInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addWish(); });
            
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFile').click());
            document.getElementById('importFile').addEventListener('change', (e) => { if (e.target.files[0]) importData(e.target.files[0]); });
            
            document.getElementById('closeCelebrationBtn').addEventListener('click', () => document.getElementById('celebrationOverlay').classList.remove('show'));
        }
    </script>
</body>
</html>
